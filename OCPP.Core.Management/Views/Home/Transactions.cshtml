@using Microsoft.AspNetCore.Mvc.Localization
@model TransactionListViewModel
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = @Localizer["Title"];
}

<style>
    .transactions-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .filter-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .control-buttons-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
    }

    .btn-remote-start {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-remote-start:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(17, 153, 142, 0.3);
        color: white;
    }

    .btn-remote-stop {
        background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-remote-stop:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(238, 9, 121, 0.3);
        color: white;
    }

    .transactions-table-wrapper {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        overflow-x: auto;
    }

    #dtTransactions {
        margin-bottom: 0;
    }

    #dtTransactions thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    #dtTransactions thead th {
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        padding: 1rem 0.75rem;
    }

    #dtTransactions tbody tr {
        transition: all 0.2s ease;
    }

    #dtTransactions tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #dtTransactions tbody td {
        vertical-align: middle;
        padding: 0.75rem;
    }

    .transaction-active {
        background-color: #d4edda !important;
        border-left: 4px solid #28a745;
    }

    .transaction-completed {
        background-color: #f8f9fa;
    }

    .badge-energy {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .filter-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
    }

    .dropdown-toggle {
        min-width: 200px;
        text-align: left;
    }

    .action-icon {
        margin-right: 0.5rem;
    }

    .refresh-indicator {
        display: inline-block;
        margin-left: 1rem;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .refresh-indicator.active {
        color: #28a745;
    }

    .auto-refresh-toggle {
        margin-left: 1rem;
    }

    @@keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    .refreshing {
        animation: pulse 1s infinite;
    }
</style>

<div class="transactions-header">
    <h2><i class="fas fa-exchange-alt"></i> @Localizer["Title"]</h2>
    <p class="mb-0">View and manage charging transactions in real-time</p>
</div>

@{
    string timespan = (Model.Timespan == 2) ? "?t=2" : ((Model.Timespan == 3) ? "?t=3" : string.Empty);

    List<ConnectorStatusViewModel> connectorStatusViewModels = new List<ConnectorStatusViewModel>();

    // Copy CP-Names in dictionary for name resolution and
    Dictionary<string, string> chargePointNames = new Dictionary<string, string>();
    if (Model.ChargePoints != null)
    {
        foreach (ChargePoint cp in Model.ChargePoints)
        {
            chargePointNames.Add(cp.ChargePointId, cp.Name);
        }
    }

    // Count connectors for every charge point (=> naming scheme)
    Dictionary<string, int> dictConnectorCount = new Dictionary<string, int>();
    string currentConnectorName = string.Empty;
    foreach (ConnectorStatus cs in Model.ConnectorStatuses)
    {
        if (dictConnectorCount.ContainsKey(cs.ChargePointId))
        {
            // > 1 connector
            dictConnectorCount[cs.ChargePointId] = dictConnectorCount[cs.ChargePointId] + 1;
        }
        else
        {
            // first connector
            dictConnectorCount.Add(cs.ChargePointId, 1);
        }

        ConnectorStatusViewModel csvm = new ConnectorStatusViewModel();
        csvm.ChargePointId = cs.ChargePointId;
        csvm.ConnectorId = cs.ConnectorId;

        string connectorName = cs.ConnectorName;
        if (string.IsNullOrEmpty(connectorName))
        {
            // Default: use charge point name
            chargePointNames.TryGetValue(cs.ChargePointId, out connectorName);
            if (string.IsNullOrEmpty(connectorName))
            {
                // Fallback: use charge point ID
                connectorName = cs.ChargePointId;
            }
            connectorName = $"{connectorName}:{cs.ConnectorId}";
        }
        csvm.ConnectorName = connectorName;
        connectorStatusViewModels.Add(csvm);

        if (cs.ChargePointId == Model.CurrentChargePointId && cs.ConnectorId == Model.CurrentConnectorId)
        {
            currentConnectorName = connectorName;
        }
    }
}

<div class="filter-card">
    <div class="row align-items-end">
        <div class="col-md-4">
            <label class="filter-label">@Localizer["ChargePointLabel"]</label>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="ddbChargePoint" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-charging-station action-icon"></i>@currentConnectorName
                </button>
                <div class="dropdown-menu" aria-labelledby="ddbChargePoint">
                    @foreach (ConnectorStatusViewModel csvm in connectorStatusViewModels)
                    {
                        <a class="dropdown-item" href="~/Home/Transactions/@Uri.EscapeDataString(csvm.ChargePointId)/@csvm.ConnectorId@timespan">
                            <i class="fas fa-plug"></i> @csvm.ConnectorName
                        </a>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <label class="filter-label">@Localizer["TimeSpanLabel"]</label>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="ddbTimespan" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-calendar-alt action-icon"></i>
                    @if (Model.Timespan == 2)
                    {
                        @Localizer["TimeSpan90"]
                    }
                    else if (Model.Timespan == 3)
                    {
                        @Localizer["TimeSpan365"]
                    }
                    else
                    {
                        @Localizer["TimeSpan30"]
                    }
                </button>
                <div class="dropdown-menu" aria-labelledby="ddbTimespan">
                    <a class="dropdown-item" href="~/Home/Transactions/@Uri.EscapeDataString(Model.CurrentChargePointId)/@Model.CurrentConnectorId">
                        <i class="fas fa-clock"></i> @Localizer["TimeSpan30"]
                    </a>
                    <a class="dropdown-item" href="~/Home/Transactions/@Uri.EscapeDataString(Model.CurrentChargePointId)/@Model.CurrentConnectorId?t=2">
                        <i class="fas fa-clock"></i> @Localizer["TimeSpan90"]
                    </a>
                    <a class="dropdown-item" href="~/Home/Transactions/@Uri.EscapeDataString(Model.CurrentChargePointId)/@Model.CurrentConnectorId?t=3">
                        <i class="fas fa-clock"></i> @Localizer["TimeSpan365"]
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-right">
            <a href="~/Home/Export/@Uri.EscapeDataString(Model.CurrentChargePointId)/@Model.CurrentConnectorId@timespan" class="btn btn-outline-success" data-toggle="tooltip" data-placement="top" title="@Localizer["DownloadCsv"]">
                <i class="fas fa-file-csv fa-lg"></i>
            </a>
            <a href="~/Home/ExportXlsx/@Uri.EscapeDataString(Model.CurrentChargePointId)/@Model.CurrentConnectorId@timespan" class="btn btn-outline-primary" data-toggle="tooltip" data-placement="top" title="@Localizer["DownloadXlsx"]">
                <i class="fas fa-file-excel fa-lg"></i>
            </a>
            <span class="refresh-indicator" id="refreshIndicator">
                <i class="fas fa-sync-alt"></i> <span id="refreshText">Auto-refresh: <span id="refreshStatus">On</span></span>
            </span>
        </div>
    </div>
</div>

<div class="control-buttons-card">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Remote Controls</h5>
            <div class="btn-group" role="group">
                @if (Model.ChargeTags != null && Model.ChargeTags.Any())
                {
                    <button type="button" class="btn btn-remote-start" onclick="RemoteStartTransaction()">
                        <i class="fas fa-play action-icon"></i>@Localizer["RemoteStart"]
                    </button>
                }
                <button type="button" class="btn btn-remote-stop" onclick="RemoteStopTransaction()">
                    <i class="fas fa-stop action-icon"></i>@Localizer["RemoteStop"]
                </button>
            </div>
        </div>
        <div class="col-md-6 text-right">
            <div class="custom-control custom-switch auto-refresh-toggle">
                <input type="checkbox" class="custom-control-input" id="autoRefreshSwitch" checked>
                <label class="custom-control-label" for="autoRefreshSwitch">Enable Auto-Refresh (30s)</label>
            </div>
        </div>
    </div>
</div>

@if (Model != null)
{
    <div class="transactions-table-wrapper">
        <table id="dtTransactions" class="table table-hover table-sm" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="th-sm">@Localizer["Connector"]</th>
                    <th class="th-sm">@Localizer["StartTime"]</th>
                    <th class="th-sm">@Localizer["StartTag"]</th>
                    <th class="th-sm">@Localizer["StartMeter"]</th>
                    <th class="th-sm">@Localizer["StopTime"]</th>
                    <th class="th-sm">@Localizer["StopTag"]</th>
                    <th class="th-sm">@Localizer["StopMeter"]</th>
                    <th class="th-sm">@Localizer["ChargeSum"]</th>
                </tr>
            </thead>
            <tbody id="transactionsTableBody">
                @if (Model.Transactions != null)
                {
                    foreach (TransactionExtended transaction in Model.Transactions)
                    {
                        // Determine connector name
                        string connectorName = string.Empty;
                        if (chargePointNames.TryGetValue(transaction.ChargePointId, out string cpName))
                        {
                            connectorName = cpName;
                        }
                        else
                        {
                            connectorName = transaction.ChargePointId;
                        }

                        if (dictConnectorCount.ContainsKey(transaction.ChargePointId) && dictConnectorCount[transaction.ChargePointId] > 1)
                        {
                            // Multiple connectors => add connector ID
                            connectorName = $"{connectorName}:{transaction.ConnectorId}";
                        }

                        // Calculate energy consumed
                        double? energyConsumed = null;
                        if (transaction.MeterStop.HasValue)
                        {
                            energyConsumed = (transaction.MeterStop.Value - transaction.MeterStart) / 1000.0; // Convert to kWh
                        }

                        // Determine if transaction is active
                        bool isActive = !transaction.StopTime.HasValue;
                        string rowClass = isActive ? "transaction-active" : "transaction-completed";

                        <tr class="@rowClass" data-transaction-id="@transaction.TransactionId">
                            <td>@connectorName</td>
                            <td>@transaction.StartTime.ToLocalTime().ToString("g")</td>
                            <td>@(string.IsNullOrEmpty(transaction.StartTagName) ? transaction.StartTagId : transaction.StartTagName)</td>
                            <td>@string.Format("{0:0.0##}", transaction.MeterStart / 1000.0) kWh</td>
                            <td>@(transaction.StopTime.HasValue ? transaction.StopTime.Value.ToLocalTime().ToString("g") : "-")</td>
                            <td>@(string.IsNullOrEmpty(transaction.StopTagName) ? (transaction.StopTagId ?? "-") : transaction.StopTagName)</td>
                            <td>@(transaction.MeterStop.HasValue ? string.Format("{0:0.0##}", transaction.MeterStop.Value / 1000.0) + " kWh" : "-")</td>
                            <td>
                                @if (energyConsumed.HasValue)
                                {
                                    <span class="badge-energy">@string.Format("{0:0.0##}", energyConsumed.Value) kWh</span>
                                }
                                else if (isActive)
                                {
                                    <span class="badge badge-success">@Localizer["Active"]</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
}

<!-- Modal for Remote Start Transaction -->
<div class="modal fade" id="remoteStartModal" tabindex="-1" role="dialog" aria-labelledby="remoteStartModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="remoteStartModalLabel">
                    <i class="fas fa-play"></i> @Localizer["RemoteStart"]
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>@Localizer["RemoteStartMessage"]</p>
                <div class="form-group">
                    <label for="chargeTagSelect">@Localizer["SelectChargeTag"]</label>
                    <select class="form-control" id="chargeTagSelect">
                        @if (Model.ChargeTags != null)
                        {
                            foreach (var tag in Model.ChargeTags)
                            {
                                <option value="@tag.TagId">@tag.TagName</option>
                            }
                        }
                    </select>
                </div>
                <div id="remoteStartResult" class="alert" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-remote-start" id="btnConfirmRemoteStart">
                    <i class="fas fa-play"></i> @Localizer["Start"]
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Remote Stop Transaction -->
<div class="modal fade" id="remoteStopModal" tabindex="-1" role="dialog" aria-labelledby="remoteStopModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="remoteStopModalLabel">
                    <i class="fas fa-stop"></i> @Localizer["RemoteStop"]
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>@Localizer["RemoteStopMessage"]</p>
                <div id="remoteStopResult" class="alert" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-remote-stop" id="btnConfirmRemoteStop">
                    <i class="fas fa-stop"></i> @Localizer["Stop"]
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var autoRefreshEnabled = true;
        var autoRefreshTimer = null;
        var dataTable = null;
        var currentChargePointId = '@Model.CurrentChargePointId';
        var currentConnectorId = @Model.CurrentConnectorId;
        var currentTimespan = '@Model.Timespan';

        $(document).ready(function() {
            dataTable = $('#dtTransactions').DataTable({
                "order": [[1, "desc"]],
                "pageLength": 25
            });

            $('[data-toggle="tooltip"]').tooltip();

            $('#autoRefreshSwitch').change(function() {
                autoRefreshEnabled = this.checked;
                if (autoRefreshEnabled) {
                    $('#refreshStatus').text('On');
                    startAutoRefresh();
                } else {
                    $('#refreshStatus').text('Off');
                    stopAutoRefresh();
                }
            });

            if (autoRefreshEnabled) {
                startAutoRefresh();
            }
        });

        function startAutoRefresh() {
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(refreshTransactions, 30000);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        function refreshTransactions() {
            $('#refreshIndicator').addClass('refreshing');
            $.ajax({
                url: '@Url.Action("GetLatestTransactions", "Home")',
                data: { chargePointId: currentChargePointId, connectorId: currentConnectorId, timespan: currentTimespan },
                success: function(data) {
                    if (data && data.transactions) {
                        updateTransactionsTable(data.transactions);
                    }
                    $('#refreshIndicator').removeClass('refreshing');
                },
                error: function() {
                    $('#refreshIndicator').removeClass('refreshing');
                }
            });
        }

        function updateTransactionsTable(transactions) {
            dataTable.clear();
            transactions.forEach(function(t) {
                var startTime = new Date(t.startTime).toLocaleString();
                var stopTime = t.stopTime ? new Date(t.stopTime).toLocaleString() : '-';
                var chargeSum = '-';
                if (t.meterStop) {
                    chargeSum = '<span class="badge-energy">' + ((t.meterStop - t.meterStart) / 1000.0).toFixed(3) + ' kWh</span>';
                } else if (!t.stopTime) {
                    chargeSum = '<span class="badge badge-success">@Localizer["Active"]</span>';
                }
                dataTable.row.add([
                    currentChargePointId + ':' + t.connectorId,
                    startTime,
                    t.startTagName || t.startTagId,
                    (t.meterStart / 1000.0).toFixed(3) + ' kWh',
                    stopTime,
                    t.stopTagName || t.stopTagId || '-',
                    t.meterStop ? (t.meterStop / 1000.0).toFixed(3) + ' kWh' : '-',
                    chargeSum
                ]);
            });
            dataTable.draw();
        }

        function RemoteStartTransaction() {
            $('#remoteStartResult').hide();
            $('#remoteStartModal').modal('show');
        }

        function RemoteStopTransaction() {
            $('#remoteStopResult').hide();
            $('#remoteStopModal').modal('show');
        }

        $('#btnConfirmRemoteStart').click(function() {
            var selectedTag = $('#chargeTagSelect').val();
            if (!selectedTag) {
                alert('@Localizer["PleaseSelectChargeTag"]');
                return;
            }
            var $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> @Localizer["Processing"]');
            $.ajax({
                url: '@Url.Action("StartTransaction", "API")/' + encodeURIComponent(currentChargePointId) + '/' + currentConnectorId + '/' + encodeURIComponent(selectedTag),
                success: function(response) {
                    $('#remoteStartResult').removeClass('alert-danger').addClass('alert-success')
                        .html('<i class="fas fa-check-circle"></i> ' + response).show();
                    $btn.prop('disabled', false).html('<i class="fas fa-play"></i> @Localizer["Start"]');
                    setTimeout(function() { refreshTransactions(); $('#remoteStartModal').modal('hide'); }, 2000);
                },
                error: function(xhr) {
                    $('#remoteStartResult').removeClass('alert-success').addClass('alert-danger')
                        .html('<i class="fas fa-exclamation-circle"></i> ' + (xhr.responseText || '@Localizer["ErrorOccurred"]')).show();
                    $btn.prop('disabled', false).html('<i class="fas fa-play"></i> @Localizer["Start"]');
                }
            });
        });

        $('#btnConfirmRemoteStop').click(function() {
            var $btn = $(this);
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> @Localizer["Processing"]');
            $.ajax({
                url: '@Url.Action("StopTransaction", "API")/' + encodeURIComponent(currentChargePointId) + '/' + currentConnectorId,
                success: function(response) {
                    $('#remoteStopResult').removeClass('alert-danger').addClass('alert-success')
                        .html('<i class="fas fa-check-circle"></i> ' + response).show();
                    $btn.prop('disabled', false).html('<i class="fas fa-stop"></i> @Localizer["Stop"]');
                    setTimeout(function() { refreshTransactions(); $('#remoteStopModal').modal('hide'); }, 2000);
                },
                error: function(xhr) {
                    $('#remoteStopResult').removeClass('alert-success').addClass('alert-danger')
                        .html('<i class="fas fa-exclamation-circle"></i> ' + (xhr.responseText || '@Localizer["ErrorOccurred"]')).show();
                    $btn.prop('disabled', false).html('<i class="fas fa-stop"></i> @Localizer["Stop"]');
                }
            });
        });

        $(window).on('beforeunload', stopAutoRefresh);
    </script>
}
